<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VWAP Tracker - BIP-20DEC30-CDE</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0a0e27;
      color: #e0e0e0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: #1a1f3a;
      border-radius: 10px;
    }

    .header h1 {
      color: #4fc3f7;
      margin-bottom: 10px;
    }

    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }

    .status.connected {
      background: #4caf50;
      color: white;
    }

    .status.disconnected {
      background: #f44336;
      color: white;
    }

    .restart-button {
      margin-top: 10px;
      padding: 8px 16px;
      background: #4fc3f7;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s;
    }

    .restart-button:hover {
      background: #29b6f6;
    }

    .restart-button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #1a1f3a;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card h3 {
      color: #9e9e9e;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #4fc3f7;
    }

    .stat-card .value.price {
      color: #fff;
    }

    .deviation {
      font-size: 18px;
      margin-top: 10px;
    }

    .deviation.positive {
      color: #4caf50;
    }

    .deviation.negative {
      color: #f44336;
    }

    .status-indicator {
      text-align: center;
      padding: 15px;
      background: #1a1f3a;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .status-indicator .label {
      font-size: 14px;
      color: #9e9e9e;
      margin-bottom: 5px;
    }

    .status-indicator .value {
      font-size: 20px;
      font-weight: bold;
    }

    .status-indicator.above {
      color: #f44336;
    }

    .status-indicator.below {
      color: #4caf50;
    }

    .info {
      background: #1a1f3a;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #2a2f4a;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #9e9e9e;
    }

    .info-value {
      color: #e0e0e0;
      font-weight: 500;
    }

    .last-update {
      text-align: center;
      color: #9e9e9e;
      font-size: 12px;
      margin-top: 20px;
    }

    .chart-container {
      background: #1a1f3a;
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .chart-container h3 {
      color: #9e9e9e;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>VWAP Tracker</h1>
      <div id="connectionStatus" class="status disconnected">Disconnected</div>
      <div style="margin-top: 10px;">
        <button id="algorithmButton" class="restart-button" onclick="toggleAlgorithm()" style="margin-right: 10px;">Start Algorithm</button>
        <button id="restartButton" class="restart-button" onclick="restartTracker()" style="background: #666; font-size: 12px; padding: 6px 12px;">Restart Tracker</button>
      </div>
      <div id="algorithmStatus" style="margin-top: 10px; color: #9e9e9e; font-size: 14px;">Algorithm: Stopped</div>
      <div id="lastUpdate" style="margin-top: 10px; color: #9e9e9e; font-size: 12px;">Waiting for data...</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>VWAP</h3>
        <div class="value" id="vwap">--</div>
      </div>

      <div class="stat-card">
        <h3>Current Price</h3>
        <div class="value price" id="currentPrice">--</div>
      </div>
    </div>

    <div class="status-indicator" id="statusIndicator">
      <div class="label">Price vs VWAP</div>
      <div class="value" id="deviation">--</div>
    </div>

    <!-- Position Display -->
    <div class="info" id="positionSection">
      <h3 style="color: #4fc3f7; margin-bottom: 15px;">Open Position</h3>
      <div class="info-item">
        <span class="info-label">Type:</span>
        <span class="info-value" id="positionType">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Size:</span>
        <span class="info-value" id="positionSize">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Entry Levels:</span>
        <span class="info-value" id="entryLevels">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Avg Entry Price:</span>
        <span class="info-value" id="avgEntryPrice">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Current Price:</span>
        <span class="info-value" id="positionCurrentPrice">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Unrealized P&L (Before Fees):</span>
        <span class="info-value" id="unrealizedPnLBeforeFees">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Entry Fees:</span>
        <span class="info-value" id="entryFees">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Estimated Exit Fees:</span>
        <span class="info-value" id="estimatedExitFees">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Fees:</span>
        <span class="info-value" id="totalFees">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Unrealized P&L (After Fees):</span>
        <span class="info-value" id="unrealizedPnLAfterFees">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Stop Loss (Absolute):</span>
        <span class="info-value" id="stopLossAbsolute">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Current Deviation:</span>
        <span class="info-value" id="positionDeviation">--</span>
      </div>
    </div>

    <!-- Reentry Status Display (when no position or waiting for reentry) -->
    <div class="info" id="reentrySection" style="display: none;">
      <h3 style="color: #ff9800; margin-bottom: 15px;">Reentry Status</h3>
      <div class="info-item">
        <span class="info-label">Status:</span>
        <span class="info-value" id="reentryStatus">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Last Stop:</span>
        <span class="info-value" id="lastStopType">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Neutral Range:</span>
        <span class="info-value" id="neutralRange">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Current Deviation:</span>
        <span class="info-value" id="reentryCurrentDeviation">--</span>
      </div>
    </div>

    <!-- Strategy Levels Display -->
    <div class="info" id="strategyLevelsSection">
      <h3 style="color: #9c27b0; margin-bottom: 15px;">Strategy Levels</h3>
      <div id="strategyLevelsContent">
        <p style="color: #9e9e9e; font-style: italic;">Waiting for VWAP data...</p>
      </div>
    </div>

    <div class="info">
      <div class="info-item">
        <span class="info-label">Product ID:</span>
        <span class="info-value" id="productId">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Candles:</span>
        <span class="info-value" id="totalCandles">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Volume:</span>
        <span class="info-value" id="totalVolume">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">Window:</span>
        <span class="info-value" id="window">--</span>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="info">
      <h3 style="color: #4fc3f7; margin-bottom: 15px;">Performance</h3>
      <div class="info-item">
        <span class="info-label">Total Trades:</span>
        <span class="info-value" id="totalTrades">0</span>
      </div>
      <div class="info-item">
        <span class="info-label">Win Rate:</span>
        <span class="info-value" id="winRate">0%</span>
      </div>
      <div class="info-item">
        <span class="info-label">Realized P&L:</span>
        <span class="info-value" id="realizedPnL">$0.00</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Return:</span>
        <span class="info-value" id="totalReturn">0%</span>
      </div>
      <div class="info-item">
        <span class="info-label">Cash Balance:</span>
        <span class="info-value" id="cashBalance">$10,000.00</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Equity:</span>
        <span class="info-value" id="totalEquity">$10,000.00</span>
      </div>
    </div>

    <div class="chart-container">
      <h3>Deviation History (72h)</h3>
      <div class="chart-wrapper">
        <canvas id="deviationChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const eventSource = new EventSource('/events');
    let isConnected = false;
    let deviationChart = null;

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data);

      // Handle status updates
      if (data.type === 'status') {
        updateConnectionStatus(data.connected);
        return;
      }

      // Update last update time for any data received
      if (data.vwap !== null && data.vwap !== undefined) {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = `Last update: ${now.toLocaleTimeString()}`;
      }

      // Handle VWAP updates
      if (data.vwap !== null && data.vwap !== undefined) {
        updateDashboard(data);
        if (!isConnected) {
          updateConnectionStatus(true);
          isConnected = true;
        }
      }

      // Handle algorithm status updates
      if (data.algorithmRunning !== undefined) {
        updateAlgorithmStatus(data.algorithmRunning);
      }
    };

    eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      updateConnectionStatus(false);
      isConnected = false;
    };

    function updateDashboard(stats) {
      // Update VWAP
      document.getElementById('vwap').textContent = formatCurrency(stats.vwap);

      // Update current price
      document.getElementById('currentPrice').textContent = formatCurrency(stats.currentPrice);

      // Update deviation
      const deviation = stats.deviation || 0;
      const deviationPercent = stats.deviationPercent || 0;
      const deviationEl = document.getElementById('deviation');
      const statusIndicator = document.getElementById('statusIndicator');

      if (deviation > 0) {
        deviationEl.textContent = `+${formatCurrency(deviation)} (+${deviationPercent.toFixed(2)}%)`;
        deviationEl.className = 'value positive';
        statusIndicator.className = 'status-indicator above';
        statusIndicator.querySelector('.label').textContent = 'ðŸ”´ Above VWAP (potentially overbought)';
      } else {
        deviationEl.textContent = `${formatCurrency(deviation)} (${deviationPercent.toFixed(2)}%)`;
        deviationEl.className = 'value negative';
        statusIndicator.className = 'status-indicator below';
        statusIndicator.querySelector('.label').textContent = 'ðŸŸ¢ Below VWAP (potentially oversold)';
      }

      // Update info
      document.getElementById('productId').textContent = stats.productId || '--';
      document.getElementById('totalCandles').textContent = stats.totalCandles?.toLocaleString() || '--';
      document.getElementById('totalVolume').textContent = stats.totalVolume?.toLocaleString(undefined, { maximumFractionDigits: 0 }) || '--';
      document.getElementById('window').textContent = `${stats.windowHours || 12} hours`;

      // Update deviation chart
      if (stats.deviationHistory && stats.deviationHistory.data) {
        updateDeviationChart(stats.deviationHistory);
      }

      // Update position display
      updatePositionDisplay(stats.position, stats.stopLossLevels, stats.reentryStatus);

      // Update strategy levels display
      if (stats.strategyLevels) {
        updateStrategyLevels(stats.strategyLevels);
      }

      // Update performance metrics
      if (stats.performance) {
        updatePerformanceDisplay(stats.performance);
      }
    }

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (connected) {
        statusEl.textContent = 'ðŸŸ¢ Connected';
        statusEl.className = 'status connected';
      } else {
        statusEl.textContent = 'ðŸ”´ Disconnected';
        statusEl.className = 'status disconnected';
      }
    }

    function formatCurrency(value) {
      if (value === null || value === undefined) return '--';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(value);
    }

    function updateAlgorithmStatus(running) {
      const button = document.getElementById('algorithmButton');
      const status = document.getElementById('algorithmStatus');

      if (running) {
        button.textContent = 'Stop Algorithm';
        button.style.background = '#f44336';
        status.textContent = 'Algorithm: Running';
        status.style.color = '#4caf50';
      } else {
        button.textContent = 'Start Algorithm';
        button.style.background = '#4fc3f7';
        status.textContent = 'Algorithm: Stopped';
        status.style.color = '#9e9e9e';
      }
    }

    async function toggleAlgorithm() {
      const button = document.getElementById('algorithmButton');
      const currentState = button.textContent === 'Start Algorithm';
      const endpoint = currentState ? '/api/algorithm/start' : '/api/algorithm/stop';
      const action = currentState ? 'Starting' : 'Stopping';

      button.disabled = true;
      button.textContent = `${action}...`;

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          updateAlgorithmStatus(result.algorithmRunning);
          if (!currentState) {
            // Algorithm stopped - positions closed
            console.log('Algorithm stopped - all positions closed');
          }
        } else {
          throw new Error(result.message || 'Failed to toggle algorithm');
        }
      } catch (error) {
        console.error('Algorithm toggle error:', error);
        alert(`Error: ${error.message}`);
        // Reset button state
        const stats = await fetch('/api/algorithm/status').then(r => r.json());
        updateAlgorithmStatus(stats.algorithmRunning);
      } finally {
        button.disabled = false;
      }
    }

    async function restartTracker() {
      const button = document.getElementById('restartButton');
      const originalText = button.textContent;

      button.disabled = true;
      button.textContent = 'Restarting...';

      try {
        const response = await fetch('/api/restart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          button.textContent = 'Restarted!';
          setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
          }, 2000);

          // Update connection status
          updateConnectionStatus(false);
          setTimeout(() => {
            updateConnectionStatus(true);
          }, 3000);
        } else {
          throw new Error(result.message || 'Restart failed');
        }
      } catch (error) {
        console.error('Restart error:', error);
        button.textContent = 'Error - Try Again';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 3000);
      }
    }

    // Periodic health check and algorithm status sync
    setInterval(async () => {
      try {
        const response = await fetch('/api/health');
        const health = await response.json();

        if (!health.connected && isConnected) {
          console.log('âš ï¸ Connection lost, updating status');
          updateConnectionStatus(false);
          isConnected = false;
        } else if (health.connected && !isConnected) {
          console.log('âœ… Connection restored');
          updateConnectionStatus(true);
          isConnected = true;
        }

        // Sync algorithm status
        const algoStatus = await fetch('/api/algorithm/status').then(r => r.json());
        updateAlgorithmStatus(algoStatus.algorithmRunning);
      } catch (error) {
        // Server might be down
        if (isConnected) {
          updateConnectionStatus(false);
          isConnected = false;
        }
      }
    }, 10000); // Check every 10 seconds

    function updateDeviationChart(deviationHistory) {
      const ctx = document.getElementById('deviationChart');
      const history = deviationHistory.data || [];
      const stats = deviationHistory.stats;

      if (history.length === 0) {
        return;
      }

      // Prepare data
      const labels = history.map(d => {
        const date = new Date(d.timestamp * 1000);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      });

      const deviationPercents = history.map(d => d.deviationPercent);
      const currentDeviationPercent = deviationPercents[deviationPercents.length - 1];

      // Create or update chart
      if (!deviationChart) {
        deviationChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              // 1st-99th percentile zone (98% range) - outermost, lightest
              {
                label: '1st Percentile',
                data: history.map(() => stats.percentile1Percent || 0),
                borderWidth: 0,
                backgroundColor: 'rgba(79, 195, 247, 0.05)',
                fill: true,
                pointRadius: 0,
                order: 5
              },
              {
                label: '99th Percentile',
                data: history.map(() => stats.percentile99Percent || 0),
                borderWidth: 0,
                backgroundColor: 'rgba(79, 195, 247, 0.05)',
                fill: '-1',
                pointRadius: 0,
                order: 5
              },
              // 5th-95th percentile zone (90% range) - middle
              {
                label: '5th Percentile',
                data: history.map(() => stats.percentile5Percent || 0),
                borderWidth: 0,
                backgroundColor: 'rgba(79, 195, 247, 0.1)',
                fill: true,
                pointRadius: 0,
                order: 4
              },
              {
                label: '95th Percentile',
                data: history.map(() => stats.percentile95Percent || 0),
                borderWidth: 0,
                backgroundColor: 'rgba(79, 195, 247, 0.1)',
                fill: '-1',
                pointRadius: 0,
                order: 4
              },
              // 10th-90th percentile zone (80% range) - innermost, darkest
              {
                label: '10th Percentile',
                data: history.map(() => stats.percentile10Percent || 0),
                borderWidth: 0,
                backgroundColor: 'rgba(79, 195, 247, 0.15)',
                fill: true,
                pointRadius: 0,
                order: 3
              },
              {
                label: '90th Percentile',
                data: history.map(() => stats.percentile90Percent || 0),
                borderWidth: 0,
                backgroundColor: 'rgba(79, 195, 247, 0.15)',
                fill: '-1',
                pointRadius: 0,
                order: 3
              },
              // Zero line (VWAP)
              {
                label: 'VWAP (0%)',
                data: history.map(() => 0),
                borderColor: '#9e9e9e',
                borderWidth: 1,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                order: 2
              },
              // Deviation line
              {
                label: 'Deviation %',
                data: deviationPercents,
                borderColor: '#4fc3f7',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                tension: 0.1,
                order: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#9e9e9e',
                  font: {
                    size: 11
                  },
                  filter: function(item, chart) {
                    // Only show main datasets in legend
                    return item.text === 'Deviation %' || item.text === 'VWAP (0%)';
                  }
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: '#1a1f3a',
                titleColor: '#e0e0e0',
                bodyColor: '#e0e0e0',
                borderColor: '#2a2f4a',
                borderWidth: 1,
                callbacks: {
                  label: function(context) {
                    if (context.datasetIndex === 7) { // Deviation line (index 7 after all percentile bands)
                      const index = context.dataIndex;
                      const point = history[index];
                      return [
                        `Deviation: ${point.deviationPercent.toFixed(2)}%`,
                        `(${formatCurrency(point.deviation)})`
                      ];
                    }
                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  color: '#9e9e9e',
                  maxTicksLimit: 12
                },
                grid: {
                  color: '#2a2f4a'
                }
              },
              y: {
                ticks: {
                  color: '#9e9e9e',
                  callback: function(value) {
                    return value.toFixed(2) + '%';
                  }
                },
                grid: {
                  color: '#2a2f4a'
                },
                title: {
                  display: true,
                  text: 'Deviation from VWAP (%)',
                  color: '#9e9e9e'
                }
              }
            }
          }
        });
      } else {
        // Update existing chart
        deviationChart.data.labels = labels;
        deviationChart.data.datasets[0].data = history.map(() => stats.percentile1Percent || 0); // 1st percentile
        deviationChart.data.datasets[1].data = history.map(() => stats.percentile99Percent || 0); // 99th percentile
        deviationChart.data.datasets[2].data = history.map(() => stats.percentile5Percent || 0); // 5th percentile
        deviationChart.data.datasets[3].data = history.map(() => stats.percentile95Percent || 0); // 95th percentile
        deviationChart.data.datasets[4].data = history.map(() => stats.percentile10Percent || 0); // 10th percentile
        deviationChart.data.datasets[5].data = history.map(() => stats.percentile90Percent || 0); // 90th percentile
        deviationChart.data.datasets[7].data = deviationPercents; // Deviation line
        deviationChart.update('none'); // 'none' mode for smooth updates
      }
    }

    function updatePositionDisplay(positionState, stopLossLevels, reentryStatus) {
      const positionSection = document.getElementById('positionSection');
      const reentrySection = document.getElementById('reentrySection');

      // Always show the position section
      positionSection.style.display = 'block';

      // Check if there's an open position
      if (!positionState || !positionState.position) {
        // No position - show placeholder values
        document.getElementById('positionType').textContent = 'No Position';
        document.getElementById('positionType').style.color = '#9e9e9e';
        document.getElementById('positionSize').textContent = '--';
        document.getElementById('entryLevels').textContent = '--';
        document.getElementById('avgEntryPrice').textContent = '--';
        document.getElementById('positionCurrentPrice').textContent = '--';
        document.getElementById('unrealizedPnLBeforeFees').textContent = '$0.00';
        document.getElementById('unrealizedPnLBeforeFees').style.color = '#9e9e9e';
        document.getElementById('entryFees').textContent = '$0.00';
        document.getElementById('estimatedExitFees').textContent = '$0.00';
        document.getElementById('totalFees').textContent = '$0.00';
        document.getElementById('unrealizedPnLAfterFees').textContent = '$0.00';
        document.getElementById('unrealizedPnLAfterFees').style.color = '#9e9e9e';
        document.getElementById('stopLossAbsolute').textContent = '--';
        document.getElementById('positionDeviation').textContent = '--';
        document.getElementById('positionDeviation').style.color = '#9e9e9e';

        // Show reentry status if waiting for neutral range
        if (reentryStatus && reentryStatus.waiting) {
          reentrySection.style.display = 'block';
          document.getElementById('reentryStatus').textContent = 'â³ Waiting for Neutral Range';
          document.getElementById('reentryStatus').style.color = '#ff9800';
          document.getElementById('lastStopType').textContent = reentryStatus.lastStopType === 'short' ? 'Short @ +2.25%' : 'Long @ -2.4%';
          document.getElementById('neutralRange').textContent = `${reentryStatus.neutralRange.min}% to ${reentryStatus.neutralRange.max}%`;

          // Get current deviation from stopLossLevels
          if (stopLossLevels && stopLossLevels.current !== null) {
            const currentDev = stopLossLevels.current;
            const devEl = document.getElementById('reentryCurrentDeviation');
            devEl.textContent = `${currentDev.toFixed(2)}%`;

            // Color code: green if in range, red if outside
            if (currentDev >= reentryStatus.neutralRange.min && currentDev <= reentryStatus.neutralRange.max) {
              devEl.style.color = '#4caf50';
            } else {
              devEl.style.color = '#ff9800';
            }
          } else {
            document.getElementById('reentryCurrentDeviation').textContent = '--';
          }
        } else {
          reentrySection.style.display = 'none';
        }
        return;
      }

      // Position exists - show actual data
      const pos = positionState.position;

      // Position type with color
      const typeEl = document.getElementById('positionType');
      typeEl.textContent = pos.type.toUpperCase();
      typeEl.style.color = pos.type === 'long' ? '#4caf50' : '#f44336';

      document.getElementById('positionSize').textContent = `${pos.totalContractCount} contract${pos.totalContractCount !== 1 ? 's' : ''} (${pos.totalSizeInBTC.toFixed(2)} BTC)`;
      document.getElementById('entryLevels').textContent = pos.entryLevels.join(', ');
      document.getElementById('avgEntryPrice').textContent = formatCurrency(pos.avgEntryPrice);
      document.getElementById('positionCurrentPrice').textContent = formatCurrency(pos.currentPrice || 0);

      // Unrealized P&L Before Fees with color
      const unrealizedPnLBeforeFeesEl = document.getElementById('unrealizedPnLBeforeFees');
      const unrealizedPnLBeforeFees = positionState.unrealizedPnLBeforeFees || 0;
      unrealizedPnLBeforeFeesEl.textContent = formatCurrency(unrealizedPnLBeforeFees);
      unrealizedPnLBeforeFeesEl.style.color = unrealizedPnLBeforeFees >= 0 ? '#4caf50' : '#f44336';

      // Entry Fees
      const entryFees = positionState.entryFees || 0;
      document.getElementById('entryFees').textContent = formatCurrency(entryFees);

      // Estimated Exit Fees
      const estimatedExitFees = positionState.estimatedExitFees || 0;
      document.getElementById('estimatedExitFees').textContent = formatCurrency(estimatedExitFees);

      // Total Fees
      const totalFees = positionState.totalFees || 0;
      document.getElementById('totalFees').textContent = formatCurrency(totalFees);

      // Unrealized P&L After Fees with color
      const unrealizedPnLAfterFeesEl = document.getElementById('unrealizedPnLAfterFees');
      const unrealizedPnLAfterFees = positionState.unrealizedPnLAfterFees || 0;
      unrealizedPnLAfterFeesEl.textContent = formatCurrency(unrealizedPnLAfterFees);
      unrealizedPnLAfterFeesEl.style.color = unrealizedPnLAfterFees >= 0 ? '#4caf50' : '#f44336';

      // Stop loss levels (absolute only - no percentile)
      if (stopLossLevels && stopLossLevels.absolute !== null) {
        document.getElementById('stopLossAbsolute').textContent = `${stopLossLevels.absolute.toFixed(2)}%`;
      } else {
        document.getElementById('stopLossAbsolute').textContent = '--';
      }

      // Hide reentry section when position is open (can't be waiting if position is open)
      reentrySection.style.display = 'none';

      // Current deviation
      if (pos.currentDeviation !== null && pos.currentDeviation !== undefined) {
        const devEl = document.getElementById('positionDeviation');
        devEl.textContent = `${pos.currentDeviation.toFixed(2)}%`;
        devEl.style.color = pos.currentDeviation >= 0 ? '#f44336' : '#4caf50';
      } else {
        document.getElementById('positionDeviation').textContent = '--';
      }
    }

    function updateStrategyLevels(levels) {
      const contentDiv = document.getElementById('strategyLevelsContent');
      if (!levels) {
        contentDiv.innerHTML = '<p style="color: #9e9e9e; font-style: italic;">Waiting for VWAP data...</p>';
        return;
      }

      const currentPrice = levels.currentPrice;
      const formatDistance = (distance) => {
        if (distance === null || distance === undefined) return 'N/A';
        const sign = distance >= 0 ? '+' : '';
        return `${sign}${distance.toFixed(2)}%`;
      };

      const formatLevel = (label, price, deviation, distance, color, thresholdComponents) => {
        const distanceStr = formatDistance(distance);
        const distanceColor = distance !== null && distance !== undefined
          ? (Math.abs(distance) < 0.5 ? '#ff9800' : '#9e9e9e')
          : '#9e9e9e';

        // Build threshold info showing max/min and both values
        let thresholdInfo = '';
        if (thresholdComponents) {
          const keys = Object.keys(thresholdComponents);
          if (keys.length === 2) {
            const percentileKey = keys.find(k => k.startsWith('p'));
            const percentileVal = thresholdComponents[percentileKey];
            const absoluteVal = thresholdComponents.absolute;

            // Determine if it's max (short) or min (long)
            const isMax = percentileKey && (percentileKey === 'p90' || percentileKey === 'p95');
            const operator = isMax ? 'max' : 'min';
            const percentileLabel = percentileKey || 'p?';

            thresholdInfo = `${operator}(${percentileLabel}=${percentileVal >= 0 ? '+' : ''}${percentileVal.toFixed(2)}%, abs=${absoluteVal >= 0 ? '+' : ''}${absoluteVal.toFixed(2)}%)`;
          }
        }

        // Format distance description
        let distanceDesc = '';
        if (distance !== null && distance !== undefined) {
          if (distance > 0) {
            distanceDesc = `${Math.abs(distance).toFixed(2)}% below entry`;
          } else if (distance < 0) {
            distanceDesc = `${Math.abs(distance).toFixed(2)}% above entry`;
          } else {
            distanceDesc = 'at entry level';
          }
        } else {
          distanceDesc = 'N/A';
        }

        return `
          <div class="info-item" style="border-left: 3px solid ${color}; padding-left: 10px; margin-bottom: 10px;">
            <div style="margin-bottom: 4px;">
              <span class="info-label" style="font-weight: 600;">${label}:</span>
              <span class="info-value" style="color: ${color}; font-weight: 600; margin-left: 8px;">${formatCurrency(price)}</span>
              <span style="font-size: 12px; color: #9e9e9e; margin-left: 8px;">(${deviation >= 0 ? '+' : ''}${deviation.toFixed(2)}% from VWAP)</span>
            </div>
            ${thresholdInfo ? `<div style="font-size: 11px; color: #757575; margin-bottom: 3px;">Threshold: ${thresholdInfo}</div>` : ''}
            <div style="font-size: 11px; color: ${distanceColor};">
              Distance: ${distanceDesc}
            </div>
          </div>
        `;
      };

      let html = `
        <div style="margin-bottom: 20px;">
          <h4 style="color: #4fc3f7; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Entry Levels:</h4>
          ${formatLevel('Short 1 Entry', levels.entries.short1.price, levels.entries.short1.deviation, levels.entries.short1.distanceFromCurrent, '#f44336', levels.entries.short1.thresholdComponents)}
          ${formatLevel('Short 2 Entry', levels.entries.short2.price, levels.entries.short2.deviation, levels.entries.short2.distanceFromCurrent, '#d32f2f', levels.entries.short2.thresholdComponents)}
          ${formatLevel('Long 1 Entry', levels.entries.long1.price, levels.entries.long1.deviation, levels.entries.long1.distanceFromCurrent, '#4caf50', levels.entries.long1.thresholdComponents)}
          ${formatLevel('Long 2 Entry', levels.entries.long2.price, levels.entries.long2.deviation, levels.entries.long2.distanceFromCurrent, '#388e3c', levels.entries.long2.thresholdComponents)}
        </div>
        <div style="margin-bottom: 20px;">
          <h4 style="color: #4fc3f7; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Exit Levels:</h4>
          ${formatLevel('Short Stop Loss', levels.exits.shortStop.price, levels.exits.shortStop.deviation, levels.exits.shortStop.distanceFromCurrent, '#ff5722')}
          ${formatLevel('Long Stop Loss', levels.exits.longStop.price, levels.exits.longStop.deviation, levels.exits.longStop.distanceFromCurrent, '#ff5722')}
          <div class="info-item" style="border-left: 3px solid #ffc107; padding-left: 10px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span class="info-label" style="font-weight: 600;">Take Profit:</span>
              <span class="info-value" style="color: #ffc107;">Â±${levels.exits.takeProfit.deviation.toFixed(2)}%</span>
            </div>
            <div style="margin-top: 4px; font-size: 12px; color: #9e9e9e;">
              <div style="display: flex; justify-content: space-between;">
                <span>Above: ${formatCurrency(levels.exits.takeProfit.priceAbove)}</span>
                <span style="color: ${levels.exits.takeProfit.distanceFromCurrentAbove !== null && Math.abs(levels.exits.takeProfit.distanceFromCurrentAbove) < 0.5 ? '#ff9800' : '#9e9e9e'};">
                  Distance: ${formatDistance(levels.exits.takeProfit.distanceFromCurrentAbove)}
                </span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 2px;">
                <span>Below: ${formatCurrency(levels.exits.takeProfit.priceBelow)}</span>
                <span style="color: ${levels.exits.takeProfit.distanceFromCurrentBelow !== null && Math.abs(levels.exits.takeProfit.distanceFromCurrentBelow) < 0.5 ? '#ff9800' : '#9e9e9e'};">
                  Distance: ${formatDistance(levels.exits.takeProfit.distanceFromCurrentBelow)}
                </span>
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
          <div class="info-item">
            <span class="info-label">VWAP:</span>
            <span class="info-value" style="color: #4fc3f7;">${formatCurrency(levels.vwap)}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Current Price:</span>
            <span class="info-value">${formatCurrency(currentPrice)}</span>
          </div>
        </div>
      `;

      contentDiv.innerHTML = html;
    }

    function updatePerformanceDisplay(performance) {
      document.getElementById('totalTrades').textContent = performance.totalTrades || 0;
      document.getElementById('winRate').textContent = `${(performance.winRate || 0).toFixed(1)}%`;

      const realizedPnLEl = document.getElementById('realizedPnL');
      const realizedPnL = performance.totalRealizedPnL || 0;
      realizedPnLEl.textContent = formatCurrency(realizedPnL);
      realizedPnLEl.style.color = realizedPnL >= 0 ? '#4caf50' : '#f44336';

      const totalReturnEl = document.getElementById('totalReturn');
      const totalReturn = performance.totalReturn || 0;
      totalReturnEl.textContent = `${totalReturn.toFixed(2)}%`;
      totalReturnEl.style.color = totalReturn >= 0 ? '#4caf50' : '#f44336';

      document.getElementById('cashBalance').textContent = formatCurrency(performance.currentCashBalance || 10000);
    }
  </script>
</body>
</html>

